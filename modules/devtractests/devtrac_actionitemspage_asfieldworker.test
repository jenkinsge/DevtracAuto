<?php

/**
 * @file
 * Visit the Action Items page as an Field worker and check that all is as
 * should be.
 */


// Make sure simpletest_clone and devtractestcase are available.
module_load_include('test', 'simpletest_clone');
module_load_include('inc', 'devtractests', 'includes/devtractestcase');

/**
 * Checks that when the Action Items page is viewed by a field worker, the
 * page and its content is all present and working as it should.
 */
class VisitActionItemsAsFieldWorkerTestCase extends DevtracTestCase {
  protected $profile = 'devtrac';

  /**
   * The getInfo function.
   */
  public static function getInfo() {
    return array(
      'name' => 'Action Items page as a Field Worker',
      'description' => 'Visit Action Items page as a Field Worker and check that all is as should be.',
      'group' => 'Devtrac2',
    );
  }

  /**
   * The setUp function.
   */
  public function setUp() {
    $this->public_files_directory = variable_get('file_public_path');
    parent::setUp(array('devtractests'));

    $this->setUpFieldWorker();
  }

  /**
   * Assess 'Action Items' page as a field worker.
   */
  public function testActionItemsPageAccessFieldWorker() {
    $this->drupalGet('');
    $this->clickLink('Action Items', 0);
    $this->assertNoText(t('Access denied'), t('Field Worker is permitted to visit the Action Items page.'), t('Devtrac'));
  }

  /**
   * Check that all generic content is present.
   */
  public function testPresenceOfGenericContentFieldWorker() {
    $this->drupalGet('');
    $this->clickLink('Action Items', 0);

    // Check for Error Messages.
    $this->assertNoRaw('<h2 class="messages-label error">Error</h2>', t('There are no errors on this page'), t('Devtrac'));

    // Check for Built by Mountbatten footer text.
    $this->assertRaw('<p><span id="project-info-footer"><a href="http://www.devtrac.org" title="Devtrac">www.devtrac.org</a> | Built by  <a href="http://www.mountbatten.net/">Mountbatten Ltd</a> | Originally developed for <a href="http://www.unicef.org/uganda">Unicef Uganda</a> Â© 2015<br /></span></p>',
        t('Correct Project Information is displayed on the page'),
        t('Devtrac'));

    // Check for link to devtrac.
    $this->assertLinkByHref('http://www.devtrac.org', 0, t('There is a link to devtrac.org on the page.'), t('Devtrac'));

    // LIST VIEW MODE.
    // Check for generic Main Menu Links.
    $this->assertLinkByHref('/sitereports', 0, t('Site Reports link is present on the page.'), t('Devtrac'));
    $this->assertLinkByHref('/statistics', 0, t('Statistics link is present on the page.'), t('Devtrac'));
    $this->assertLinkByHref('/adminunits', 0, t('Admin Units link is present on the page.'), t('Devtrac'));
    $this->assertLinkByHref('/locations', 0, t('Locations link is present on the page.'), t('Devtrac'));
    $this->assertLinkByHref('/actionitems', 0, t('Action Items link is present on the page.'), t('Devtrac'));
    $this->assertLinkByHref('/fieldtrips', 0, t('Field trips link is present on the page.'), t('Devtrac'));
    $this->assertLinkByHref('/images', 0, t('Images link is present on the page.'), t('Devtrac'));
    $this->assertLinkByHref('/users', 0, t('Users link is present on the page.'), t('Devtrac'));
    $this->assertLink('Log out', 0, t('LOG OUT link is present on the page.'), t('Devtrac'));

    // Check for view mode button links.
    $this->assertLinkByHref('/actionitems?display=default', 0, t('Default display link is present on the page.'), t('Devtrac'));
    $this->assertLinkByHref('/actionitems?display=graphs', 0, t('Graphs display link is present on the page.'), t('Devtrac'));

    // Check that the my-profile menu is present.
    $this->assertLink('Welcome, Test', 0, t('My profile menu is present on the page.'), t('Devtrac'));
    $this->assertLink('Add Field Trip', 0, t('Add Field Trip link is present on the page.'), t('Devtrac'));
    $this->assertLink('Edit My Profile', 0, t('Edit My Profile link is present on the page.'), t('Devtrac'));

    // Check for Export links.
    $this->assertLink('Export', 0, t('Export link is present on the page.'), t('Devtrac'));
    $this->assertNoLinkByHref('/actionitems/analyse/csvadmin', t('Export to CSV (administrator version) link is not present on the page.'), t('Devtrac'));
    $this->assertLink('Export to CSV', 0, t('Export to CSV link is present on the page.'), t('Devtrac'));
    $this->assertLink('Export to KML', 0, t('Export to KML link is present on the page.'), t('Devtrac'));
    $this->assertLink('Subscribe to RSS Feed', 0, t('Subscribe to RSS Feed link is present on the page.'), t('Devtrac'));

    // Check for Facet default state (expanded or collapsed).
    // Check.
    // 2 is collapsible, default open.
    // 3 is collapisble, default closed.

    // Due Date block id block-facetapi-1rwxj6vssjf01xgzxpu5mxc5euqvvnve.
    $this->assertRaw('"block-facetapi-1rwxj6vssjf01xgzxpu5mxc5euqvvnve":3', t('Due Date block is collapsed by default.'), t('Devtrac'));

    // Status block id block-facetapi-8ck8uqcgosot5ofnhtoladrlqz02lkdm.
    $this->assertRaw('"block-facetapi-8ck8uqcgosot5ofnhtoladrlqz02lkdm":3', t('Report block is collapsed by default.'), t('Devtrac'));

    // Priority block id block-facetapi-1kixdi9imkbq8g6eqg5fohxvfng4vw9t.
    $this->assertRaw('"block-facetapi-1kixdi9imkbq8g6eqg5fohxvfng4vw9t":3', t('Admin Unit block is collapsed by default.'), t('Devtrac'));

    // Admin Unit Tags block id block-facetapi-oyhhuvsyko9snzz04k1gjf3icy6l4oem.
    $this->assertRaw('"block-facetapi-oyhhuvsyko9snzz04k1gjf3icy6l4oem":3', t('Admin Unit Tags block is collapsed by default.'), t('Devtrac'));

    // Tags block id block-facetapi-uulb6nu1kwf1109nqm10twgrji1s2yg6.
    $this->assertRaw('"block-facetapi-uulb6nu1kwf1109nqm10twgrji1s2yg6":3', t('Location block is collapsed by default.'), t('Devtrac'));

    // Admin Unit block id block-facetapi-9v2lgys4yvh3sg0swlgzqrrqnfrk8cpw.
    $this->assertRaw('"block-facetapi-9v2lgys4yvh3sg0swlgzqrrqnfrk8cpw":3', t('Admin Unit block is collapsed by default.'), t('Devtrac'));

    // Sector block id block-facetapi-yrre28gatxo7f09ivqpdh2nrr2yja14p.
    $this->assertRaw('"block-facetapi-yrre28gatxo7f09ivqpdh2nrr2yja14p":3', t('Sector block is collapsed by default.'), t('Devtrac'));

    // Responsible block id block-facetapi-juh0liko1i0pkeepvdfe5jri5goyrg57.
    $this->assertRaw('"block-facetapi-juh0liko1i0pkeepvdfe5jri5goyrg57":3', t('Responsible block is collapsed by default.'), t('Devtrac'));

    // Responsible's Manager block id block-facetapi-ucj8e9q0dd6c2sdmssjubiugwhn2t38m.
    $this->assertRaw('"block-facetapi-ucj8e9q0dd6c2sdmssjubiugwhn2t38m":3', t('Responsible block is collapsed by default.'), t('Devtrac'));

    // User block id block-facetapi-jobz0vr9jh1vmqykxnx6xkndwnb7qop0.
    $this->assertRaw('"block-facetapi-jobz0vr9jh1vmqykxnx6xkndwnb7qop0":3', t('User block is collapsed by default.'), t('Devtrac'));

    // Manager block id block-facetapi-3e4ui5x81k1n21nyjx9lscde5uru0ox0.
    $this->assertRaw('"block-facetapi-3e4ui5x81k1n21nyjx9lscde5uru0ox0":3', t('Manager block is collapsed by default.'), t('Devtrac'));

    // Date block id block-facetapi-4cxsg2rkmolp5sr1dvbwmeazs9p9h1lz.
    $this->assertRaw('"block-facetapi-4cxsg2rkmolp5sr1dvbwmeazs9p9h1lz":3', t('Date block is collapsed by default.'), t('Devtrac'));

    // Information pane block id block-pane-action-items-info.
    $this->assertRaw('"block-pane-action-items-info":3', t('Information pane block is collapsed by default.'), t('Devtrac'));

    // Check for Action Item counter.
    $this->assertRaw('<div class="current-search-item current-search-item-text current-search-item-results"><h3 class="">4 Action Items</h3></div>', t('Current search counter is present on the page'), t('Devtrac'));

    // Check for no : in Date Visited.
    // High level.
    $this->assertNoPatternInBody('/([01]?[0-9]|[2][0-3])\:([0-5][0-9]|[6][0])/', t('No links with time found on a high level on the page.'), t('Devtrac'));
    // Low Level.
    $this->clickLinkUsingXpath('November 2014 ', 0, '//*[@id="facetapi-facet-search-apidevtrac-solr-action-items-index-block-field-actionitem-due-date"]/li[3]/a');
    $this->clickLinkUsingXpath('November 1, 2014 ', 0, '//*[@id="facetapi-facet-search-apidevtrac-solr-action-items-index-block-field-actionitem-due-date"]/li/div[2]/ul/li[2]/a');
    $this->assertNoPatternInBody('/([01]?[0-9]|[2][0-3])\:([0-5][0-9]|[6][0])/', t('No links with time found on a low level on the page.'), t('Devtrac'));

    $this->drupalGet('');
    $this->clickLink('Action Items');

    // Check for order of Facets.
    $order = array('Admin Unit', 'Sector', 'Status', 'Priority', 'Admin Unit Tags', 'Due Date', 'Tags', 'Responsible', 'Responsible\'s Manager', 'Date', 'User', 'Manager');
    $this->assertFacetOrder($order, t('Facets are in the correct order.'), t('Devtrac'));

    // Search Api Elements.
    // Check for Facets.

    // Due Date.
    $this->assertRaw('<h2 class="block-title">Due Date</h2>', t('Due Date Heading is present on the page'), t('Devtrac'));
    $this->assertRaw('<div class="item-list"><ul class="facetapi-facetapi-date-only-links facetapi-facet-field-actionitem-due-date" id="facetapi-facet-search-apidevtrac-solr-action-items-index-block-field-actionitem-due-date">', t('Due Date search list is present on the page'), t('Devtrac'));

    // Status.
    $this->assertRaw('<h2 class="block-title">Status</h2>', t('Status Heading is present on the page'), t('Devtrac'));
    $this->assertRaw('<div class="item-list"><ul class="facetapi-facetapi-links facetapi-facet-field-actionitem-status" id="facetapi-facet-search-apidevtrac-solr-action-items-index-block-field-actionitem-status">', t('Status search list is present on the page'), t('Devtrac'));

    // Priority.
    $this->assertRaw('<h2 class="block-title">Priority</h2>', t('Priority Heading is present on the page'), t('Devtrac'));
    $this->assertRaw('<div class="item-list"><ul class="facetapi-facetapi-links facetapi-facet-field-actionitem-severity" id="facetapi-facet-search-apidevtrac-solr-action-items-index-block-field-actionitem-severity">', t('Priority search list is present on the page'), t('Devtrac'));

    // Admin Unit Tags.
    $this->assertRaw('<h2 class="block-title">Admin Unit Tags</h2>', t('Admin Unit Tags Heading is present on the page'), t('Devtrac'));
    $this->assertRaw('<div class="item-list"><ul class="facetapi-facetapi-links facetapi-facet-taxonomy-vocabulary-6field-district-category" id="facetapi-facet-search-apidevtrac-solr-action-items-index-block-taxonomy-vocabulary-6field-district-category">', t('Admin Unit Tags search list is present on the page'), t('Devtrac'));

    // Tags.
    $this->assertRaw('<h2 class="block-title">Tags</h2>', t('Tags Heading is present on the page'), t('Devtrac'));
    $this->assertRaw('<div class="item-list"><ul class="facetapi-facetapi-links facetapi-facet-field-action-items-tags" id="facetapi-facet-search-apidevtrac-solr-action-items-index-block-field-action-items-tags">', t('Tags search list is present on the page'), t('Devtrac'));

    // Admin Unit.
    $this->assertRaw('<h2 class="block-title">Admin Unit</h2>', t('Admin Unit Heading is present on the page'), t('Devtrac'));
    $this->assertRaw('<div class="item-list"><ul class="facetapi-facetapi-links facetapi-facet-taxonomy-vocabulary-6" id="facetapi-facet-search-apidevtrac-solr-action-items-index-block-taxonomy-vocabulary-6">', t('Admin Unit search list is present on the page'), t('Devtrac'));

    // Sector.
    $this->assertRaw('<h2 class="block-title">Sector</h2>', t('Sector Heading is present on the page'), t('Devtrac'));
    $this->assertRaw('<div class="item-list"><ul class="facetapi-search-api-swatches facetapi-facet-taxonomy-vocabulary-8" id="facetapi-facet-search-apidevtrac-solr-action-items-index-block-taxonomy-vocabulary-8">', t('Sector search list is present on the page'), t('Devtrac'));

    // Responsible.
    $this->assertRaw('<h2 class="block-title">Responsible</h2>', t('Responsible Heading is present on the page'), t('Devtrac'));
    $this->assertRaw('<div class="item-list"><ul class="facetapi-facetapi-links facetapi-facet-field-actionitem-responsible" id="facetapi-facet-search-apidevtrac-solr-action-items-index-block-field-actionitem-responsible">', t('Responsible search list is present on the page'), t('Devtrac'));

    // Responsible's Manager.
    $this->assertRaw('<h2 class="block-title">Responsible\'s Manager</h2>', t('Responsible\'s Manager Heading is present on the page'), t('Devtrac'));
    $this->assertRaw('<div class="item-list"><ul class="facetapi-facetapi-links facetapi-facet-field-actionitem-responsiblefield-user-superior" id="facetapi-facet-search-apidevtrac-solr-action-items-index-block-field-actionitem-responsiblefield-user-superior">', t('Responsible\'s Manager search list is present on the page'), t('Devtrac'));

    // User.
    $this->assertRaw('<h2 class="block-title">User</h2>', t('User Heading is present on the page'), t('Devtrac'));
    $this->assertRaw('<div class="item-list"><ul class="facetapi-facetapi-links facetapi-facet-author" id="facetapi-facet-search-apidevtrac-solr-action-items-index-block-author">', t('User search list is present on the page'), t('Devtrac'));

    // Manager.
    $this->assertRaw('<h2 class="block-title">Manager</h2>', t('Manager Heading is present on the page'), t('Devtrac'));
    $this->assertRaw('<div class="item-list"><ul class="facetapi-facetapi-links facetapi-facet-authorfield-user-superior" id="facetapi-facet-search-apidevtrac-solr-action-items-index-block-authorfield-user-superior">', t('Manager search list is present on the page'), t('Devtrac'));

    // Date.
    $this->assertRaw('<h2 class="block-title">Date</h2>', t('Date Heading is present on the page'), t('Devtrac'));
    $this->assertRaw('<div class="item-list"><ul class="facetapi-facetapi-links facetapi-facet-created" id="facetapi-facet-search-apidevtrac-solr-action-items-index-block-created">', t('Date search list is present on the page'), t('Devtrac'));

    // Check for fulltest search block.
    $this->assertRaw('<form id="facetapi-textfield-widget-form" class="facetapi-textfield-widget-form" action="actionitems" method="GET" onsubmit="return Drupal.facetapiTextfieldWidget.submitForm(search_api_aggregation_1)">
  <input type="textfield" name="search_api_aggregation_1" value="" />
  <div id="edit-actions" class="form-actions form-wrapper">
    <input type="submit" class="form-submit" value="Search" />
  </div>
</form> ', t('Full text search block is present on the page'), t('Devtrac'));

    // Check for Site Report counter.
    $this->assertRaw('<div class="current-search-item current-search-item-text current-search-item-results"><h3 class="">4 Action Items</h3></div>', t('Current search counter is present on the page'), t('Devtrac'));

    // Check for table.
    // Columns and Headings.
    $this->assertRaw('<th data-class="expand" >
            Title          </th>', t('Title table column and heading is present on the page.'), t('Devtrac'));
    $this->assertRaw('<th data-hide="phone,tablet" class="views-field views-field-taxonomy-vocabulary-6" >
            Admin Unit          </th>', t('Admin Unit table column and heading is present on the page.'), t('Devtrac'));
    $this->assertRaw('<th data-hide="phone" class="views-field views-field-taxonomy-vocabulary-8" >
            Sector          </th>', t('Sector table column and heading is present on the page.'), t('Devtrac'));
    $this->assertRaw('/actionitems?order=field_actionitem_status&amp;sort=asc" title="sort by Status" class="active">Status</a>          </th>', t('Status table column and heading is present on the page. This column is also sortable.'), t('Devtrac'));
    $this->assertRaw('/actionitems?order=field_actionitem_due_date&amp;sort=asc" title="sort by Due Date" class="active">Due Date</a>          </th>', t('Due Date table column and heading is present on the page. This column is also sortable.'), t('Devtrac'));
    $this->assertRaw('<th data-hide="phone,tablet" class="views-field views-field-field-actionitem-responsible" >
            Responsible          </th>', t('Resposible table column and heading is present on the page.'), t('Devtrac'));
    // $this->assertRaw('<th data-hide="phone" class="views-field views-field-virtual-field" >
    //                  </th>', t('Empty Button table column and heading is present on the page.'), t('Devtrac'));

    // Check that data is displayed in each column.
    $this->assertLink('Community Mobilization for SIA', 0, t('Title column is filled.'), t('Devtrac'));
    $this->assertLink('Undefined Area', 0, t('Admin Unit column is filled.'), t('Devtrac'));
    $this->assertRaw('width="16" height="16" alt="Infectious disease control" title="Infectious disease control" /></a>', t('Sector column is filled'), t('Devtrac'));
    $this->assertRaw('<td class="views-field views-field-field-actionitem-status" >
            Closed          </td>', t('Status column is filled.'), t('Devtrac'));
    $this->assertRaw('<td class="views-field views-field-field-actionitem-due-date" >
            <span class="date-display-single">31-01-2015</span>          </td>', t('Due Date column is filled.'), t('Devtrac'));
    $this->assertRaw('/admin">Site Admin</a>          </td>', t('Responsible column is filled.'), t('Devtrac'));
    // $this->assertRaw('<th class="views-field views-field-virtual-field" data-hide="phone"></th>',
    // t('Empty Button table heading is present on the page'), t('Devtrac'));
    $this->assertNoLink('Edit', t('Edit button is not present.'), t('Devtrac'));
    $this->assertNoLink('Delete', t('Delete button is not present.'), t('Devtrac'));

    // Check for date format.
    $this->assertPattern('/([012]?[1-9]|[12]0|3[01])\-(0?[1-9]|1[012])\-([0-9]{4})/', t('Date format is correct'), t('Devtrac'));

    // Check for Info pane text.
    $this->assertRaw('<div class="content clearfix">
      <p>An Action item is a task that a user can assign to another user within the system. They contain a comments section where progress on the action item can be tracked. Only when the action item has been satisfactorily worked can it be closed by the person responsible.</p>
    </div>', t('Info pane is present on the page'), t('Devtrac'));

    // GRAPHS VIEW MODE.
    // Check that link to graphs view mode goes to the right page.
    $this->clickLink('graphs');
    $this->assertUrl($this->getAbsoluteUrl('/actionitems?display=graphs'), array(), t('User is redirected to the correct page when list view mode link is clicked.'), t('Devtrac'));

    // Check for Error Messages.
    $this->assertNoRaw('<h2 class="messages-label error">Error</h2>', t('There are no errors on this page'), t('Devtrac'));

    // Check for generic Main Menu Links.
    $this->assertLinkByHref('/sitereports', 0, t('Site Reports link is present on the page.'), t('Devtrac'));
    $this->assertLinkByHref('/statistics', 0, t('Statistics link is present on the page.'), t('Devtrac'));
    $this->assertLinkByHref('/adminunits', 0, t('Admin Units link is present on the page.'), t('Devtrac'));
    $this->assertLinkByHref('/locations', 0, t('Locations link is present on the page.'), t('Devtrac'));
    $this->assertLinkByHref('/actionitems', 0, t('Action Items link is present on the page.'), t('Devtrac'));
    $this->assertLinkByHref('/fieldtrips', 0, t('Field trips link is present on the page.'), t('Devtrac'));
    $this->assertLinkByHref('/images', 0, t('Images link is present on the page.'), t('Devtrac'));
    $this->assertLinkByHref('/users', 0, t('Users link is present on the page.'), t('Devtrac'));
    $this->assertLink('Log out', 0, t('LOG OUT link is present on the page.'), t('Devtrac'));

    // Check for view mode button links.
    $this->assertLinkByHref('/actionitems?display=default', 0, t('Default display link is present on the page.'), t('Devtrac'));
    $this->assertLinkByHref('/actionitems?display=graphs', 0, t('Graphs display link is present on the page.'), t('Devtrac'));

    // Check that the my-profile menu is present.
    $this->assertLink('Welcome, Test', 0, t('My profile menu is present on the page.'), t('Devtrac'));
    $this->assertLink('Add Field Trip', 0, t('Add Field Trip link is present on the page.'), t('Devtrac'));
    $this->assertLink('Edit My Profile', 0, t('Edit My Profile link is present on the page.'), t('Devtrac'));

    // Check for Export links.
    $this->assertLink('Export', 0, t('Export link is present on the page.'), t('Devtrac'));
    $this->assertNoLinkByHref('/actionitems/analyse/csvadmin', t('Export to CSV (administrator version) link is  not present on the page.'), t('Devtrac'));
    $this->assertLink('Export to CSV', 0, t('Export to CSV link is present on the page.'), t('Devtrac'));
    $this->assertLink('Export to KML', 0, t('Export to KML link is present on the page.'), t('Devtrac'));
    $this->assertLink('Subscribe to RSS Feed', 0, t('Subscribe to RSS Feed link is present on the page.'), t('Devtrac'));

    // Check for Facet default state (expanded or collapsed).
    // Check.
    // 2 is collapsible, default open.
    // 3 is collapisble, default closed.

    // Due Date block id block-facetapi-1rwxj6vssjf01xgzxpu5mxc5euqvvnve.
    $this->assertRaw('"block-facetapi-1rwxj6vssjf01xgzxpu5mxc5euqvvnve":3', t('Due Date block is collapsed by default.'), t('Devtrac'));

    // Status block id block-facetapi-8ck8uqcgosot5ofnhtoladrlqz02lkdm.
    $this->assertRaw('"block-facetapi-8ck8uqcgosot5ofnhtoladrlqz02lkdm":3', t('Report block is collapsed by default.'), t('Devtrac'));

    // Priority block id block-facetapi-1kixdi9imkbq8g6eqg5fohxvfng4vw9t.
    $this->assertRaw('"block-facetapi-1kixdi9imkbq8g6eqg5fohxvfng4vw9t":3', t('Admin Unit block is collapsed by default.'), t('Devtrac'));

    // Admin Unit Tags block id block-facetapi-oyhhuvsyko9snzz04k1gjf3icy6l4oem.
    $this->assertRaw('"block-facetapi-oyhhuvsyko9snzz04k1gjf3icy6l4oem":3', t('Admin Unit Tags block is collapsed by default.'), t('Devtrac'));

    // Tags block id block-facetapi-uulb6nu1kwf1109nqm10twgrji1s2yg6.
    $this->assertRaw('"block-facetapi-uulb6nu1kwf1109nqm10twgrji1s2yg6":3', t('Location block is collapsed by default.'), t('Devtrac'));

    // Admin Unit block id block-facetapi-9v2lgys4yvh3sg0swlgzqrrqnfrk8cpw.
    $this->assertRaw('"block-facetapi-9v2lgys4yvh3sg0swlgzqrrqnfrk8cpw":3', t('Admin Unit block is collapsed by default.'), t('Devtrac'));

    // Sector block id block-facetapi-yrre28gatxo7f09ivqpdh2nrr2yja14p.
    $this->assertRaw('"block-facetapi-yrre28gatxo7f09ivqpdh2nrr2yja14p":3', t('Sector block is collapsed by default.'), t('Devtrac'));

    // Responsible block id block-facetapi-juh0liko1i0pkeepvdfe5jri5goyrg57.
    $this->assertRaw('"block-facetapi-juh0liko1i0pkeepvdfe5jri5goyrg57":3', t('Responsible block is collapsed by default.'), t('Devtrac'));

    // Responsible's Manager block id block-facetapi-ucj8e9q0dd6c2sdmssjubiugwhn2t38m.
    $this->assertRaw('"block-facetapi-ucj8e9q0dd6c2sdmssjubiugwhn2t38m":3', t('Responsible block is collapsed by default.'), t('Devtrac'));

    // User block id block-facetapi-jobz0vr9jh1vmqykxnx6xkndwnb7qop0.
    $this->assertRaw('"block-facetapi-jobz0vr9jh1vmqykxnx6xkndwnb7qop0":3', t('User block is collapsed by default.'), t('Devtrac'));

    // Manager block id block-facetapi-3e4ui5x81k1n21nyjx9lscde5uru0ox0.
    $this->assertRaw('"block-facetapi-3e4ui5x81k1n21nyjx9lscde5uru0ox0":3', t('Manager block is collapsed by default.'), t('Devtrac'));

    // Date block id block-facetapi-4cxsg2rkmolp5sr1dvbwmeazs9p9h1lz.
    $this->assertRaw('"block-facetapi-4cxsg2rkmolp5sr1dvbwmeazs9p9h1lz":3', t('Date block is collapsed by default.'), t('Devtrac'));

    // Information pane block id block-pane-action-items-info.
    $this->assertRaw('"block-pane-action-items-info":3', t('Information pane block is collapsed by default.'), t('Devtrac'));

    // Check for Action Item counter.
    $this->assertRaw('<div class="current-search-item current-search-item-text current-search-item-results"><h3 class="">4 Action Items</h3></div>', t('Current search counter is present on the page'), t('Devtrac'));

    // Check for no : in Date Visited.
    // High level.
    $this->assertNoPatternInBody('/([01]?[0-9]|[2][0-3])\:([0-5][0-9]|[6][0])/', t('No links with time found on a high level on the page.'), t('Devtrac'));
    // Low Level.
    $this->clickLinkUsingXpath('November 2014 ', 0, '//*[@id="facetapi-facet-search-apidevtrac-solr-action-items-index-block-field-actionitem-due-date"]/li[3]/a');
    $this->clickLinkUsingXpath('November 1, 2014 ', 0, '//*[@id="facetapi-facet-search-apidevtrac-solr-action-items-index-block-field-actionitem-due-date"]/li/div[2]/ul/li[2]/a');
    $this->assertNoPatternInBody('/([01]?[0-9]|[2][0-3])\:([0-5][0-9]|[6][0])/', t('No links with time found on a low level on the page.'), t('Devtrac'));

    $this->drupalGet('');
    $this->clickLink('Action Items');
    $this->clickLink('graphs');

    // Check for order of Facets.
    $order = array('Admin Unit', 'Sector', 'Status', 'Priority', 'Admin Unit Tags', 'Due Date', 'Tags', 'Responsible', 'Responsible\'s Manager', 'Date', 'User', 'Manager');
    $this->assertFacetOrder($order, t('Facets are in the correct order.'), t('Devtrac'));

    // Search Api Elements.
    // Check for Facets.

    // Due Date.
    $this->assertRaw('<h2 class="block-title">Due Date</h2>', t('Due Date Heading is present on the page'), t('Devtrac'));
    $this->assertRaw('<div class="item-list"><ul class="facetapi-facetapi-date-only-links facetapi-facet-field-actionitem-due-date" id="facetapi-facet-search-apidevtrac-solr-action-items-index-block-field-actionitem-due-date">', t('Due Date search list is present on the page'), t('Devtrac'));

    // Status.
    $this->assertRaw('<h2 class="block-title">Status</h2>', t('Status Heading is present on the page'), t('Devtrac'));
    $this->assertRaw('<div class="item-list"><ul class="facetapi-facetapi-links facetapi-facet-field-actionitem-status" id="facetapi-facet-search-apidevtrac-solr-action-items-index-block-field-actionitem-status">', t('Status search list is present on the page'), t('Devtrac'));

    // Priority.
    $this->assertRaw('<h2 class="block-title">Priority</h2>', t('Priority Heading is present on the page'), t('Devtrac'));
    $this->assertRaw('<div class="item-list"><ul class="facetapi-facetapi-links facetapi-facet-field-actionitem-severity" id="facetapi-facet-search-apidevtrac-solr-action-items-index-block-field-actionitem-severity">', t('Priority search list is present on the page'), t('Devtrac'));

    // Admin Unit Tags.
    $this->assertRaw('<h2 class="block-title">Admin Unit Tags</h2>', t('Admin Unit Tags Heading is present on the page'), t('Devtrac'));
    $this->assertRaw('<div class="item-list"><ul class="facetapi-facetapi-links facetapi-facet-taxonomy-vocabulary-6field-district-category" id="facetapi-facet-search-apidevtrac-solr-action-items-index-block-taxonomy-vocabulary-6field-district-category">', t('Admin Unit Tags search list is present on the page'), t('Devtrac'));

    // Tags.
    $this->assertRaw('<h2 class="block-title">Tags</h2>', t('Tags Heading is present on the page'), t('Devtrac'));
    $this->assertRaw('<div class="item-list"><ul class="facetapi-facetapi-links facetapi-facet-field-action-items-tags" id="facetapi-facet-search-apidevtrac-solr-action-items-index-block-field-action-items-tags">', t('Tags search list is present on the page'), t('Devtrac'));

    // Admin Unit.
    $this->assertRaw('<h2 class="block-title">Admin Unit</h2>', t('Admin Unit Heading is present on the page'), t('Devtrac'));
    $this->assertRaw('<div class="item-list"><ul class="facetapi-facetapi-links facetapi-facet-taxonomy-vocabulary-6" id="facetapi-facet-search-apidevtrac-solr-action-items-index-block-taxonomy-vocabulary-6">', t('Admin Unit search list is present on the page'), t('Devtrac'));

    // Sector.
    $this->assertRaw('<h2 class="block-title">Sector</h2>', t('Sector Heading is present on the page'), t('Devtrac'));
    $this->assertRaw('<div class="item-list"><ul class="facetapi-search-api-swatches facetapi-facet-taxonomy-vocabulary-8" id="facetapi-facet-search-apidevtrac-solr-action-items-index-block-taxonomy-vocabulary-8">', t('Sector search list is present on the page'), t('Devtrac'));

    // Responsible.
    $this->assertRaw('<h2 class="block-title">Responsible</h2>', t('Responsible Heading is present on the page'), t('Devtrac'));
    $this->assertRaw('<div class="item-list"><ul class="facetapi-facetapi-links facetapi-facet-field-actionitem-responsible" id="facetapi-facet-search-apidevtrac-solr-action-items-index-block-field-actionitem-responsible">', t('Responsible search list is present on the page'), t('Devtrac'));

    // Responsible's Manager.
    $this->assertRaw('<h2 class="block-title">Responsible\'s Manager</h2>', t('Responsible\'s Manager Heading is present on the page'), t('Devtrac'));
    $this->assertRaw('<div class="item-list"><ul class="facetapi-facetapi-links facetapi-facet-field-actionitem-responsiblefield-user-superior" id="facetapi-facet-search-apidevtrac-solr-action-items-index-block-field-actionitem-responsiblefield-user-superior">', t('Responsible\'s Manager search list is present on the page'), t('Devtrac'));

    // User.
    $this->assertRaw('<h2 class="block-title">User</h2>', t('User Heading is present on the page'), t('Devtrac'));
    $this->assertRaw('<div class="item-list"><ul class="facetapi-facetapi-links facetapi-facet-author" id="facetapi-facet-search-apidevtrac-solr-action-items-index-block-author">', t('User search list is present on the page'), t('Devtrac'));

    // Manager.
    $this->assertRaw('<h2 class="block-title">Manager</h2>', t('Manager Heading is present on the page'), t('Devtrac'));
    $this->assertRaw('<div class="item-list"><ul class="facetapi-facetapi-links facetapi-facet-authorfield-user-superior" id="facetapi-facet-search-apidevtrac-solr-action-items-index-block-authorfield-user-superior">', t('Manager search list is present on the page'), t('Devtrac'));

    // Date.
    $this->assertRaw('<h2 class="block-title">Date</h2>', t('Date Heading is present on the page'), t('Devtrac'));
    $this->assertRaw('<div class="item-list"><ul class="facetapi-facetapi-links facetapi-facet-created" id="facetapi-facet-search-apidevtrac-solr-action-items-index-block-created">', t('Date search list is present on the page'), t('Devtrac'));

    // Check for fulltest search block.
    $this->assertRaw('<form id="facetapi-textfield-widget-form" class="facetapi-textfield-widget-form" action="actionitems" method="GET" onsubmit="return Drupal.facetapiTextfieldWidget.submitForm(search_api_aggregation_1)">
  <input type="textfield" name="search_api_aggregation_1" value="" />
  <input type="hidden" name="display" value="graphs" />
  <div id="edit-actions" class="form-actions form-wrapper">
    <input type="submit" class="form-submit" value="Search" />
  </div>
</form>', t('Full text search block is present on the page'), t('Devtrac'));

    // Check for Site Report counter.
    $this->assertRaw('<div class="current-search-item current-search-item-text current-search-item-results"><h3 class="">4 Action Items</h3></div>', t('Current search counter is present on the page'), t('Devtrac'));

    // Check for the quicktabs.
    // Status.
    $this->assertRaw('/actionitems?display=graphs&amp;qt-devtrac_actionitems_graph_tabs=0#qt-devtrac_actionitems_graph_tabs" id="quicktabs-tab-devtrac_actionitems_graph_tabs-0" class="quicktabs-tab quicktabs-tab-block quicktabs-tab-block-b17325578dfba4f3abd318cd9efa7009 active">Status</a>', t('Status quicktab is present on the page'), t('Devtrac'));
    $this->assertLink('Status', 0, t('Status Quicktab is labeled'), t('Devtrac'));

    // Priority.
    $this->assertRaw('/actionitems?display=graphs&amp;qt-devtrac_actionitems_graph_tabs=1#qt-devtrac_actionitems_graph_tabs" id="quicktabs-tab-devtrac_actionitems_graph_tabs-1" class="quicktabs-tab quicktabs-tab-block quicktabs-tab-block-31303ac46ed27b9166851e6e4c6895a7 active">Priority</a>', t('Priority quicktab is present on the page'), t('Devtrac'));
    $this->assertLink('Priority', 0, t('Priority Quicktab is labeled'), t('Devtrac'));

    // Sectors.
    $this->assertRaw('/actionitems?display=graphs&amp;qt-devtrac_actionitems_graph_tabs=2#qt-devtrac_actionitems_graph_tabs" id="quicktabs-tab-devtrac_actionitems_graph_tabs-2" class="quicktabs-tab quicktabs-tab-block quicktabs-tab-block-acf17946f753cccc102716e4aca4b922 active">Sectors</a>', t('Sectors quicktab is present on the page'), t('Devtrac'));
    $this->assertLink('Sectors', 0, t('Sectors Quicktab is labeled'), t('Devtrac'));

    // Districts.
    $this->assertRaw('/actionitems?display=graphs&amp;qt-devtrac_actionitems_graph_tabs=3#qt-devtrac_actionitems_graph_tabs" id="quicktabs-tab-devtrac_actionitems_graph_tabs-3" class="quicktabs-tab quicktabs-tab-block quicktabs-tab-block-39d8061cf74fab2d69eeca8b249f0881 active">Districts</a>', t('Districts quicktab is present on the page'), t('Devtrac'));
    $this->assertLink('Districts', 0, t('Districts Quicktab is labeled'), t('Devtrac'));

    // Users.
    $this->assertRaw('/actionitems?display=graphs&amp;qt-devtrac_actionitems_graph_tabs=4#qt-devtrac_actionitems_graph_tabs" id="quicktabs-tab-devtrac_actionitems_graph_tabs-4" class="quicktabs-tab quicktabs-tab-block quicktabs-tab-block-451e1443d2a9f8b0784ab053cf4ac325 active">Users</a>', t('Users quicktab is present on the page'), t('Devtrac'));

    // ENABLING A FILTER.
    $this->assertLinkByHref('/actionitems?display=graphs&f[0]=taxonomy_vocabulary_8%3A18', 0, t('Filtered by Basic Education link is present on the page.'), t('Devtrac'));
    // $this->drupalGet('?display=graphs&f[0]=taxonomy_vocabulary_8%3A19');
    $this->clickLinkUsingXpath('Basic education', 0, '//*[@id="facetapi-facet-search-apidevtrac-solr-action-items-index-block-taxonomy-vocabulary-8"]/li[1]/a');

    // Check for current search block.
    $this->assertRaw('<div class="current-search-item current-search-item-devtracgroup current-search-item-devtrac7-actionitem-fieldgroup">', t('Current search block is visible when a filter is clicked.'), t('Devtrac'));
    $this->assertRaw('/actionitems?display=graphs" rel="nofollow" class="taxonomy-vocabulary-8 beautytips" title="Sector">Basic education [X] <span class="element-invisible"> Remove Basic education filter </span></a></li></ul></div></div>    </div>', t('Current search link to remove the filter  is present after a filter is clicked.'), t('Devtrac'));

    // Check main menu links.
    $this->assertLinkByHref('/sitereports?display=graphs&f[0]=taxonomy_vocabulary_8%3A18', 0, t('Filtered Site Reports link is present on the page.'), t('Devtrac'));
    $this->assertLinkByHref('/statistics?display=graphs&f[0]=taxonomy_vocabulary_8%3A18', 0, t('Filtered Statistics link is present on the page.'), t('Devtrac'));
    $this->assertLinkByHref('/adminunits?display=graphs&f[0]=taxonomy_vocabulary_8%3A18', 0, t('Filtered Admin Units link is present on the page.'), t('Devtrac'));
    $this->assertLinkByHref('/locations?display=graphs&f[0]=taxonomy_vocabulary_8%3A18', 0, t('Filtered Locations link is present on the page.'), t('Devtrac'));
    $this->assertLinkByHref('/images?display=graphs&f[0]=taxonomy_vocabulary_8%3A18', 0, t('Filtered Images link is present on the page.'), t('Devtrac'));

    // Check for view mode button links.
    $this->assertLinkByHref('/actionitems?display=default&f[0]=taxonomy_vocabulary_8%3A18', 0, t('Default display link is present on the page.'), t('Devtrac'));
    $this->assertLinkByHref('/actionitems?display=graphs&f[0]=taxonomy_vocabulary_8%3A18', 0, t('Graphs display link is present on the page.'), t('Devtrac'));

    // Check for Export links.
    $this->assertLinkByHref('/actionitems/analyse/csv?display=graphs&f[0]=taxonomy_vocabulary_8%3A18', 0, t('Export to CSV link is present on the page.'), t('Devtrac'));
    $this->assertLinkByHref('/actionitems/analyse/kml?display=graphs&f[0]=taxonomy_vocabulary_8%3A18', 0, t('Export to KML link is present on the page.'), t('Devtrac'));
    $this->assertLinkByHref('/actionitems/analyse/feed?display=graphs&f[0]=taxonomy_vocabulary_8%3A18', 0, t('Subscribe to RSS Feed link is present on the page.'), t('Devtrac'));

    
    $this->drupalGet('');
    $this->clickLink('Action Items');
    $this->clickLink('graphs');

    // EXPORTS.
    // CSV.
    $this->clickLink('Export to CSV', 0);

    // Check for column names.
    $this->assertRaw('"Title","Admin Unit","Sector","Status","Due Date","Responsible","Task","Tags (Categories)","UUID","Location UUID","URL","Sitereport UUID"', t('All column names are present.'), t('Devtrac'));

    // Check for count of column names.
    $length = 140;
    $column_names_line = substr($this->drupalGetContent(), 0, $length);
    $this->verbose($column_names_line);
    $column_names = preg_split("/[,]+/", $column_names_line);
    $this->verbose(var_export($column_names, TRUE));
    if (count($column_names) == 12) {
      $this->pass(t('CSV Column count is correct.'), t('Devtrac'));
    }
    else {
      $this->fail(t('CSV Column Count is wrong.'), t('Devtrac'));
    }

    // Fields.
    // Title.
    $this->assertRaw('"Test Action Item"', t('Title field is filled.'), t('Devtrac'));
    // Admin Unit.
    $this->assertRaw('"Undefined Area"',t('Admin Unit field is filled.'), t('Devtrac'));
    // Sector.
    $this->assertRaw('"Educational research"', t('Sector field is filled.'), t('Devtrac'));
    // Status.
    $this->assertRaw('"Open"',t('Status field is filled.'), t('Devtrac'));
    // Due Date.
    $this->assertRaw('"' . date("d-m-Y") . '"', t('Due Date field is filled.'), t('Devtrac'));
    // Responsible.
    $this->assertRaw('"Test Fieldworker"', t('Responsible field is filled.'), t('Devtrac'));
    // Task.
    $this->assertRaw('"Testing presence of Edit button."', t('Task field is filled.'), t('Devtrac'));
    // Tags (Categories).
    $this->assertRaw('"Urgent"', t('Tags (Categories) field is filled.'), t('Devtrac'));
    // UUID (Subject to change).
    // $this->assertRaw('"72262913-b484-4252-b6fc-935a3638bc63"',t('UUID field is filled.'), t('Devtrac'));
    // Location UUID (Subject to change).
    // $this->assertRaw('"e8d12f48-5b5d-439e-85ea-d1785ffbf7d6"', t('Location UUID field is filled.'), t('Devtrac'));
    // URL (Subject to change).
    // $this->assertRaw('/uuid/node/72262913-b484-4252-b6fc-935a3638bc63"',
    // t('URL field is filled.'), t('Devtrac'));
    // "Sitereport UUID" (Subject to change).
    // $this->assertRaw('72262913-b484-4252-b6fc-935a3638bc63/uuid/node/e8d12f48-5b5d-439e-85ea-d1785ffbf7d6"',
    // t('"Sitereport UUID" field is filled.'), t('Devtrac'));

    // KML.
    $this->drupalGet('');
    $this->clickLink('Action Items');
    $this->clickLink('graphs');
    $this->clickLink('Export to KML', 0);
    // Name : Title.
    $this->assertRaw('<name>
    <![CDATA[Community Mobilization for SIA]]>
  </name>', t('Name field is mapped correctly.'), t('Devtrac'));
    // Description : Report.
    $this->assertRaw('<description>
    <![CDATA[]]>
  </description>', t('Description field is mapped correctly.'), t('Devtrac'));
    // Point : Lon - Lat.
    $this->assertRaw('<Point>
    <coordinates>0,0,0</coordinates>
  </Point>', t('Coordinates field is mapped correctly.'), t('Devtrac'));

    // RSS Feeds.
    $this->drupalGet('');
    $this->clickLink('Action Items');
    $this->clickLink('graphs');
    $this->clickLink('Subscribe to RSS Feed', 0);

    // Core items.
    // Title : title.
    $this->assertRaw('<title>Test Action Item</title>', t('Title is mapped correctly'), t('Devtrac'));
    // Link : site_info (Subject to change).
    // $this->assertRaw('<link>http://www.devtrac.ug/node/26</link>', t('Link is mapped correctly'), t('Devtrac'));
    // Author : author.
    $this->assertRaw('<author>Test Fieldworker</author>', t('Author is mapped correctly'), t('Devtrac'));
    // Category : taxonomy_vocabulary_8.
    $this->assertRaw('<category>Undefined Area, Educational research</category>', t('Category is mapped correctly'), t('Devtrac'));
    // Guid : uuid (Subject to change).
    // $this->assertRaw('<guid isPermaLink="false">http://www.devtrac.ug/node/26</guid>',
    // t('Guid is mapped correctly'), t('Devtrac'));
    // Published Date : created (Subject to change).
    // $this->assertRaw('<pubDate>Friday, January 23, 2015 - 10:19</pubDate>',
    // t('Published Date is mapped correctly'), t('Devtrac'));
    // Source : field_ftritem_public_summary.
    $this->assertRaw('/actionitems/analyse/feed?display=graphs">RSS Feed</source>', t('Source is mapped correctly'), t('Devtrac'));

    // dc items.
    // Title : title.
    $this->assertRaw('<dc:title>Test Action Item</dc:title>', t('dc Title is mapped correctly'), t('Devtrac'));
    // Creator : author.
    $this->assertRaw('<dc:creator>Test Fieldworker</dc:creator>', t('dc Author is mapped correctly'), t('Devtrac'));
    // Subject : taxonomy_vocabulary_8.
    $this->assertRaw('<dc:subject>Undefined Area, Educational research</dc:subject>', t('dc Subject is mapped correctly'), t('Devtrac'));
    // Publisher : site_info_1 (Subject to change).
    // Date : created (Subject to change).
    // Identifier : uuid (Subject to change).
    // $this->assertRaw('<dc:identifier>http://www.devtrac.ug/node/26</dc:identifier>',
    // t('dc Guid is mapped correctly'), t('Devtrac'));
    // Coverage : taxonomy_vocabulary_6.
    $this->assertRaw('<dc:coverage>Undefined Area</dc:coverage>', t('dc Coverage is mapped correctly'), t('Devtrac'));

    // Georss items.
    // Point : field_ftritem_lat_long_lon.
    $this->assertRaw('<georss:point> 0 </georss:point>', t('georss Point is mapped correctly'), t('Devtrac'));
    // FeatureName : title.
    $this->assertRaw('<georss:featureName>Test Action Item</georss:featureName>', t('georss FeatureName is mapped correctly'), t('Devtrac'));

  }
}
